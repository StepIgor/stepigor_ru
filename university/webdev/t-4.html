<!--
    ПИ18-2 Степанов И.
    Задание t-4
    Номер по списку: 23

    Реализовать справочник на LocalStorage
    1) В виде списка
    2) Содержать должен пять полей (один из них ключ, остальные придумать)
    3) Добавление производить после ввода # (решетки) в конце поля новых значений
    4) Удаление реализовать по номеру позиции
    5) Позволить изменять отдельные элементы (придумать самому, как)

    Ссылки:
    Мой хостинг:    https://stepigor.ru/university/webdev/t-4.html
    JSFiddle:       https://jsfiddle.net/stepigor/419xLcta/
	
	Общий вид структуры справочника:
	1)номер строки (это порядковый номер массива в общем массиве)
	2)номер телефона
	3)Фамилия, имя
	4)Дата рождения
	5)адрес проживания
 -->

<!DOCTYPE html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>t-4</title>
  </head>
  <body style="background:lightgrey;text-align:center;">
  
	<!-- подпись и описание задания -->
    <table border="3" style="margin:0 auto;" id="task_info">
      <tr>
        <td style="text-align:center;">
          <h2 style="color:darkgreen;">ПИ18-2 - Степанов И.</h2>
        </td>
      </tr>
      <tr>
        <td style="text-align:left;">
          Реализовать справочник на LocalStorage<br><br>
          1) В виде списка<br>
          2) Содержать должен пять полей (один из них ключ, остальные придумать)<br>
          3) Добавление производить после ввода # (решетки) в конце поля новых значений<br>
          4) Удаление реализовать по номеру позиции<br>
          5) Позволить изменять отдельные элементы (придумать самому, как)<br>
        </td>
      </tr>
      <tr>
        <td style="text-align:center;">
          Ссылки на работу:<br>
          <a href="https://stepigor.ru/university/webdev/t-4.html" target="_blank">https://stepigor.ru/university/webdev/t-4.html</a><br>
          <a href="https://jsfiddle.net/stepigor/419xLcta/" target="_blank">https://jsfiddle.net/stepigor/419xLcta/</a>
        </td>
      </tr>
    </table>

	<!-- триггер на скрытие или закрытие таблицы выше -->
    <span style="color:red;cursor:pointer;font-size:24px;" onclick="$('#task_info').toggle()"><u>Скрыть/отобразить таблицу</u></span>

	<!-- заголовок -->
    <div style="margin-top:25px;">
      <h2 style="color:darkgreen;">Справочник клиентов компании</h2>
    </div>
	
	<!-- список действий -->
	<div style="text-align:center;font-size:20px;color:blue;margin-bottom:15px;">
		<u style="cursor:pointer;"><span onclick="$('#new_client').slideToggle();">Добавить клиента</span>
		<span style="margin-left:20px" onclick="$('#change_client').slideToggle();">Изменить клиента</span>
		<span style="margin-left:20px" onclick="$('#del_client').slideToggle();">Удалить клиента</span>
		</u>
	</div>
	
	<!-- поля добавления клиента -->
	<div id="new_client" style="display:none;margin-bottom:15px;text-align:center;">
		<b>Новый клиент:</b><br>
		<input type="text" id="new_phonenum" maxlength="15" value="9-999-999-99-99" placeholder="Телефон">
		<input type="text" id="new_name" maxlength="24" value="Сидоров Иван" placeholder="Фамилия, имя">
		<input type="date" id="new_date" value="2020-01-01" placeholder="Дата рождения">
		<input type="text" id="new_addr" maxlength="30" value="ул. Щербаковская, д. 38" placeholder="Адрес проживания"><br>
		<span style="color:red;">Для подтверждения ввода поставьте символ # (решетки) В КОНЦЕ поля с адресом проживания!!!</span>
	</div>
	
	<!-- поля удаления клиента -->
	<div id="del_client" style="display:none;margin-bottom:15px;text-align:center;">
		<b>Введите номер клиента для удаления:</b><br>
		<input type="number" id="del_number" value="2"> <button onclick="remove_now($('#del_number').val())">Удалить!</button>
	</div>
	
	<!-- поле изменения клиента	-->
	<div id="change_client" style="display:none;margin-bottom:15px;text-align:center;">
		<b>Введите номер клиента для изменения:</b><br>
		<input type="number" id="chg_number" value="2"> <button id="call_change_subblock_but" onclick="trytochange_now($('#chg_number').val())">Изменить!</button>
		<div id="update_subblock" style="display:none">
			<input type="text" id="edit_phonenum" maxlength="15" value="" placeholder="Телефон">
			<input type="text" id="edit_name" maxlength="24" value="" placeholder="Фамилия, имя">
			<input type="date" id="edit_date" value="" placeholder="Дата рождения">
			<input type="text" id="edit_addr" maxlength="30" value="" placeholder="Адрес проживания">
			<button onclick="save_updated_data()">Сохранить изменения!</button>
		</div>
	</div>
	
	<!-- сам справочник -->
	<div style="font-family:courier new;font-size:12px;text-align:center;margin:0 auto;width:95%;" id="guidebook">
		
	</div>

	<!-- небольшая самореклама -->
	<div id="notice" style="position:fixed;left:5px;bottom:5px;background:rgba(255,255,255,0.75);border-radius:5px;padding:15px;text-align:left;max-width:25%;">
		<img src="https://diary.difres.ru/favicon.png" style="width:32px;height:32px;vertical-align:middle;"> <a href="https://diary.difres.ru" target="_blank" style="font-family:calibri;color:darkblue;font-size:24px;vertical-align:middle;text-decoration:none;">Дневник | difres.ru</a>
		<br>
		<div style="font-size:16px;margin-top:15px;">
			Давно написанное мною приложение на JS, дающее возможность вести свой дневник. Активно используется LocalStorage.
			<br><br>
			<b>Страница в JS Store:</b> <a href="https://jsstore.difres.ru/product.html?id=1" target="_blank">перейти</a>
		</div>
		<br>
		<span onclick="$('#notice').toggle()" style="color:red;cursor:pointer;">Закрыть</span>
	</div>

    <!-- JQuery -->
    <script src="https://difres.ru/js/jquery.js"></script>
	
	<!-- Механизм работы -->
	<script>
		//своя функция подгонки размера строкового поля
		function str_resize(str, sz){ //сама строка + требуемый размер в символах (вставка пробелов)
			if (str.length == sz) return str;
			var str_new = str;
			var str_len = str_new.length;
			while (str_len != sz){
				str_new += '\u00A0';
				str_len++;
				if (str_len > 30){		//защита от своей невнимательности
					return str_new;
				}
			}
			return str_new;
		}
		
		//проверяем, впервые ли производится открытие страницы
		if (localStorage.getItem('stepigor-dict') == null){
			var new_dict = [['8-800-555-35-35','Степанов Игорь', '07.10.2000', 'ул. Кораблестроителей, д. 8'],
							['8-933-345-35-22','Лисейчева Мария', '03.12.2001', 'ул. Пешеходов, д. 12'],
							['8-917-742-12-11','Иванова Диана', '11.05.2000', 'ул. Советская, д. 5'],]; 				//начальный справочник
							
			//запишем в память
			localStorage.setItem('stepigor-dict', JSON.stringify(new_dict));
		}
		
		//рисуем шапку
		$('#guidebook').html('<b>'+str_resize('№ п/п', 10)+str_resize('Номер телефона', 18)+str_resize('Фамилия, имя', 25)+str_resize('Дата рождения', 20)+str_resize('Адрес проживания', 30)+'</b><hr><div id="put_here"></div>');
		
		//функция обновления содержимого (отображение пользователю)
		
		function refresh_dict(){
			$('#put_here').html('');
			var act_dict = JSON.parse(localStorage.getItem('stepigor-dict'));
			var total_count = 0;
			for (ind in act_dict){
				$('#put_here').append(str_resize(String(total_count), 10)+str_resize(act_dict[ind][0], 18)+str_resize(act_dict[ind][1], 25)+str_resize(act_dict[ind][2], 20)+str_resize(act_dict[ind][3], 30)+'<br>');
				total_count++;
			}
		}
		
		//процедура ввода нового клиента
		$('#new_addr').bind('keyup', function(e){
			if ($('#new_addr').val()[$('#new_addr').val().length - 1] == '#'){		//если ввели в конце #, то пытаемся добавить запись в справочник
				var phone_test = /^[0-9]{1}[-]{1}[0-9]{3}[-]{1}[0-9]{3}[-]{1}[0-9]{2}[-]{1}[0-9]{2}$/.test($('#new_phonenum').val());	//правильно ли ввели номер телефона
				var name_test = $('#new_name').val().split(' ').length == 2;	//не пусто ли поле имени
				var addr_test = $('#new_addr').val().length < 2;	//не пусто ли поле адреса
				var date_test = $('#new_date').val() == '';		//не пусто ли поле даты
				if (phone_test == true){
					if (name_test != true || $('#new_name').val().length < 3){
						alert('Фамилия и имя - это 2 слова.');
						return;
					}
					if (addr_test == true){
						alert('Адрес не может быть пустым, ведь живет же человек где-то?!');
						return;
					}
					if (date_test == true){
						alert('Дата не может быть пустой!');
						return;
					}
					var new_client = [];		//массив будет включен в общий
					new_client.push($('#new_phonenum').val());	//добавляем по очереди поля
					new_client.push($('#new_name').val());
					
					
					//блок переработки формата даты на привычный нам (с тире на точки!)
					var new_date = new Date($('#new_date').val());
					var nd_day = new_date.getDate() >= 10 ? new_date.getDate() : ("0" + new_date.getDate());
					var nd_month = new_date.getMonth() < 9 ? ("0" + (new_date.getMonth() + 1)) : new_date.getMonth() + 1;
					var nd_year = new_date.getFullYear();
					new_client.push(nd_day + '.' + nd_month + '.' + nd_year);					
					
					new_client.push($('#new_addr').val().slice(0, $('#new_addr').val().length - 1));
					
					var act_dict = JSON.parse(localStorage.getItem('stepigor-dict'));	//читаем из хранилища актуальный словарь
					act_dict.push(new_client);
					localStorage.setItem('stepigor-dict', JSON.stringify(act_dict));	//записываем изменения в хранилище
					
					alert('Успешно добавлено!');
					
					$('#new_client').slideToggle();		//прячем форму ввода
					refresh_dict();
					$('#new_addr').val($('#new_addr').val().slice(0, $('#new_addr').val().length - 1));		//удаляем решетку в конце поля
				} else {
					alert('Неправильно введен номер телефона. Отмена операции.');
				}
			}
		});
		
		
		//процедура удаления клиента
		function remove_now(cli_id){
			var act_dict = JSON.parse(localStorage.getItem('stepigor-dict'));
			if (cli_id >= 0 && cli_id < act_dict.length){
				act_dict.splice(cli_id, 1);
				localStorage.setItem('stepigor-dict', JSON.stringify(act_dict));
				alert('Удаление выполнено!');
				refresh_dict();
			} else {
				alert('Клиента с таким id нет, увы!');
			}
		}
		
		var cli_id_to_update = null;	//номер клиента для изменения
		
		//попытка найти клиента для изменения
		function trytochange_now(cli_id){
			var act_dict = JSON.parse(localStorage.getItem('stepigor-dict'));
			
			if (cli_id >=0 && cli_id < act_dict.length){
				cli_id_to_update = cli_id;
				$('#update_subblock').slideToggle();
				
				//предзаполнение полей
				$('#edit_phonenum').val(act_dict[cli_id][0]);
				$('#edit_name').val(act_dict[cli_id][1]);
				$('#edit_date').val(act_dict[cli_id][2].split('.')[2]+'-'+act_dict[cli_id][2].split('.')[1]+'-'+act_dict[cli_id][2].split('.')[0]);
				$('#edit_addr').val(act_dict[cli_id][3]);
			} else {
				alert('Клиента с таким id нет, увы!');
				if ($('#update_subblock').css('display') == 'block'){	//прячем форму ввода
					$('#update_subblock').slideToggle();
				}
			}
		}
		
		function save_updated_data(){	//сохранение измененных данных
			var act_dict = JSON.parse(localStorage.getItem('stepigor-dict'));
			
			if (!(cli_id_to_update >=0 && cli_id_to_update < act_dict.length)){	//защита от махинаций формами со стороны пользователя
				alert('Клиент уже не существует под данным id');
				return;
			}
		
			var phone_test = /^[0-9]{1}[-]{1}[0-9]{3}[-]{1}[0-9]{3}[-]{1}[0-9]{2}[-]{1}[0-9]{2}$/.test($('#edit_phonenum').val());	//правильно ли ввели номер телефона
				var name_test = $('#edit_name').val().split(' ').length == 2;	//проверка, аналогична в функции ввода нового клиента
				var addr_test = $('#edit_addr').val().length < 2;
				var date_test = $('#edit_date').val() == '';
				if (phone_test == true){
					if (name_test != true || $('#edit_name').val().length < 3){
						alert('Фамилия и имя - это 2 слова.');
						return;
					}
					if (addr_test == true){
						alert('Адрес не может быть пустым, ведь живет же человек где-то?!');
						return;
					}
					if (date_test == true){
						alert('Дата не может быть пустой!');
						return;
					}
					var new_client = [];	//данный массив будет вставлен по индексу в общий
					new_client.push($('#edit_phonenum').val());
					new_client.push($('#edit_name').val());
					//блок переработки формата даты на привычный нам (с тире на точки!)
					var new_date = new Date($('#edit_date').val());
					var nd_day = new_date.getDate() >= 10 ? new_date.getDate() : ("0" + new_date.getDate());
					var nd_month = new_date.getMonth() < 9 ? ("0" + (new_date.getMonth() + 1)) : new_date.getMonth() + 1;
					var nd_year = new_date.getFullYear();
					new_client.push(nd_day + '.' + nd_month + '.' + nd_year);					
					new_client.push($('#edit_addr').val());

					act_dict[cli_id_to_update] = new_client;

					localStorage.setItem('stepigor-dict', JSON.stringify(act_dict));
					alert('Успешно обновлено!');
					if ($('#update_subblock').css('display') == 'block') $('#update_subblock').slideToggle();	//прячем форму ввода
					$('#change_client').slideToggle();
					refresh_dict();
				} else {
					alert('Неправильно введен номер телефона. Отмена операции.');
				}
		}
		
		refresh_dict(); //первое отображение справочника
	</script>
  </body>
</html>
